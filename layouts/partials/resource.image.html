{{- $thePage      :=  index . `page`    }}
{{- $theImgClass  := (index . `class`) | default ""       }}
{{- $theImgStyle  := (index . `style`) | default ""       }}
{{- $theResImg    := (index . `img`)   | default ``       }}
{{- $theResImgCmd := (index . `cmd`)   | default `Resize` }}
{{- $theResImgOpt := (index . `opt`)   | default `300x`   }}

{{- $thePage.Scratch.Set `myResImg` ``}}
{{- $thePage.Scratch.Set `myImage`  ``}}

{{- if or $thePage.Site.Params.debug (findRE `\bhtml-comment\b` ($thePage.Site.Param `traceFlags`) ) }}
  {{ `<!-- partials/resource.image.html  -->` | safeHTML }}
{{- end}}

{{- if or $thePage.Site.Params.debug (findRE `\bdebug-partial(s|-resource-image)\b` ($thePage.Site.Param `traceFlags`) ) }}
<br/>
thePage        : {{- $thePage        }} <br/>
theImgClass    : {{- $theImgClass    }} <br/>
theImgStyle    : {{- $theImgStyle    }} <br/>
theResImg      : {{- $theResImg      }} <br/>
theResImgCmd   : {{- $theResImgCmd   }} <br/>
theResImgOpt   : {{- $theResImgOpt   }} <br/>
thePage.Parent : {{- $thePage.Parent }} <br/>
{{- end }}

{{- $theResources := $thePage.Site.GetPage "page" "resources/images" }}
      {{- if or $thePage.Site.Params.debug (findRE `\bdebug-partial(s|-resource-image)\b` ($thePage.Site.Param `traceFlags`) ) }}
      <br/>
      theResources: {{- $theResources }} <br/>
      {{- end }}
{{- if $theResources }}
  {{- if len ($theResources.Resources.ByType `image`) }}
    {{- if ($theResImg)  }}
      {{ $thePage.Scratch.Set `myResImg` ( ($theResources.Resources.ByType `image`).GetMatch ($theResImg) ) }}
      {{- if or $thePage.Site.Params.debug (findRE `\bdebug-partial(s|-resource-image)\b` ($thePage.Site.Param `traceFlags`) ) }}
      <br/>
      myResImg: {{- $thePage.Scratch.Get `myResImg` }} <br/>
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if $thePage.Parent }}
  {{- range $myResource := ($thePage.Parent).Resources.Match "**"  }}
      <br/> fooooo
      thePage.Parent      : {{ $thePage.Parent.File.Path      }} <br/>
      .Name               : {{ $myResource.Name               }} <br/>
      .Title              : {{ $myResource.Title              }} <br/>
      .ResourceType       : {{ $myResource.ResourceType       }} <br/>
      .Permalink          : {{ $myResource.Permalink          }} <br/>
      .RelPermalink       : {{ $myResource.RelPermalink       }} <br/>
  {{- end }} {{/* range */}}

  {{- if $thePage.Parent.Resources.ByType `image` }}
    {{- if ($theResImg)  }}
      {{ $thePage.Scratch.Set `myResImg` ( ( ($thePage.Parent.Resources.ByType `image`).GetMatch ($theResImg))  | default ($thePage.Scratch.Get `myResImg`) ) }}
        {{- if or $thePage.Site.Params.debug (findRE `\bdebug-partial(s|-resource-image)\b` ($thePage.Site.Param `traceFlags`) ) }}
        <br/>
        myResImg: {{- $thePage.Scratch.Get `myResImg` }} <br/>
        {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if $thePage.Resources.ByType `image` }}
  {{- if ($theResImg)  }}
    {{ $thePage.Scratch.Set `myResImg` ( ( ($thePage.Resources.ByType `image`).GetMatch ($theResImg))  | default ($thePage.Scratch.Get `myResImg`) ) }}
      {{- if or $thePage.Site.Params.debug (findRE `\bdebug-partial(s|-resource-image)\b` ($thePage.Site.Param `traceFlags`) ) }}
      <br/>
      myResImg: {{- $thePage.Scratch.Get `myResImg` }} <br/>
      {{- end }}
  {{- end }}
{{- end }}

{{- $myResource := $thePage.Scratch.Get `myResImg` }}
{{- if and $myResource (ne $myResource ``) }}
  {{- if      eq $theResImgCmd `Fill`   }}{{$thePage.Scratch.Set `myImage` ($myResource.Fill   $theResImgOpt)}}
  {{- else if eq $theResImgCmd `Fit`    }}{{$thePage.Scratch.Set `myImage` ($myResource.Fit    $theResImgOpt)}}
  {{- else if eq $theResImgCmd `Resize` }}{{$thePage.Scratch.Set `myImage` ($myResource.Resize $theResImgOpt)}}
  {{- else }}
    {{- errorf "Invalid image processing command: '%s' for '%s'. Must be one of Fill, Fit or Resize."  $myResource $theResImgCmd}}
  {{- end }}
{{- end }}
{{- $myImage := $thePage.Scratch.Get `myImage` }}

{{- if $myImage }}
<img
  class="{{ $theImgClass }}"
  style="{{ $theImgStyle  | safeCSS }}"
  src='{{ $myImage.Permalink    }}'
  alt='{{ $myImage.RelPermalink }}'
  >
{{- end }}
